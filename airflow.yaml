x-airflow-common: &airflow-common
  build:
    context: ./airflow
  environment:
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@airflow-db/${AIRFLOW_DB}
    AIRFLOW__WEBSERVER__SECRET_KEY: ${AIRFLOW_WEBSERVER_SECRET_KEY}
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'True'
    AIRFLOW__SMTP__SMTP_HOST: mailhog
    AIRFLOW__SMTP__SMTP_PORT: 1025
    AIRFLOW__SMTP__SMTP_MAIL_FROM: airflow@example.com
    AIRFLOW__SMTP__SMTP_STARTTLS: 'False'
    AIRFLOW__SMTP__SMTP_SSL: 'False'
    AIRFLOW__SMTP__SMTP_USER: ''
    AIRFLOW__SMTP__SMTP_PASSWORD: ''
    # Auto-created connections (Airflow reads AIRFLOW_CONN_<ID> on startup)
    AIRFLOW_CONN_TRINO_DEFAULT: trino://trino@trino:8080/iceberg
    AIRFLOW_CONN_MINIO_DEFAULT: aws://${AWS_ACCESS_KEY_ID}:${AWS_SECRET_ACCESS_KEY}@/?endpoint_url=${S3_ENDPOINT}
  volumes:
    - ./airflow/dags:/opt/airflow/dags
  networks:
    iceberg_net:
  depends_on:
    - airflow-db

services:
  airflow-db:
    container_name: airflow-db
    image: postgres:18
    environment:
      POSTGRES_USER: ${AIRFLOW_DB_USER}
      POSTGRES_PASSWORD: ${AIRFLOW_DB_PASSWORD}
      POSTGRES_DB: ${AIRFLOW_DB}
    volumes:
      - ./airflow/db:/var/lib/postgresql
    networks:
      iceberg_net:

  mailhog:
    container_name: mailhog
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      iceberg_net:

  airflow-webserver:
    container_name: airflow-webserver
    <<: *airflow-common
    ports:
      - "8085:8080"
    command: webserver
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  airflow-scheduler:
    container_name: airflow-scheduler
    <<: *airflow-common
    command: scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  airflow-init:
    container_name: airflow-init
    <<: *airflow-common
    command: >
      bash -c "
        airflow db init &&
        airflow users create --username ${AIRFLOW_ADMIN_USER} --password ${AIRFLOW_ADMIN_PASSWORD} --firstname Admin --lastname User --role Admin --email ${AIRFLOW_ADMIN_EMAIL}
      "

networks:
  iceberg_net:
